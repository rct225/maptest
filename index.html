<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
		<link rel="stylesheet" href="examples-style.css">
		<title>index</title>

	</head>

	<body>

<span class="page">

<link rel="stylesheet" type="text/css" href="style.css">

<script type="text/javascript" src="http://www.google.com/jsapi?key=AIzaSyD_fj0xR-lPF4MWfJ7gVS_TOoF-P69l7dk"></script>
	<script type="text/javascript">
		google.load("jquery", '1.3');
		google.load("maps", "2.x");
	</script>
	
	<script type="text/javascript">
	$(document).ready(function(){ 

		var map = new GMap2($("#map").get(0)); // set the element 'map' as container
		var cheltenham = new GLatLng(40.521482,-74.461516); // set the lat long for the center point
		map.setCenter(cheltenham, 9); // value 1 is the center, value 2 is the zoom level

		var bounds = new GLatLngBounds();
		var geo = new GClientGeocoder(); 

		// setup a bunch of status codes
		var reasons=[];
			reasons[G_GEO_SUCCESS]            = "Success";
			reasons[G_GEO_MISSING_ADDRESS]    = "Missing Address";
			reasons[G_GEO_UNKNOWN_ADDRESS]    = "Unknown Address.";
			reasons[G_GEO_UNAVAILABLE_ADDRESS]= "Unavailable Address";
			reasons[G_GEO_BAD_KEY]            = "Bad API Key";
			reasons[G_GEO_TOO_MANY_QUERIES]   = "Too Many Queries";
			reasons[G_GEO_SERVER_ERROR]       = "Server error";

			
			// initial load points
				$.ajax({
					dataType: "jsonp",
					url: "http://127.0.0.1:8000/locations/list",
					data: function(json) {
					alert("FOO");
					if (json.length > 0) {
						for (i=0; i<json.length; i++) {
							var location = json[i];
							addLocation(location);
						}
						zoomToBounds();
					}
					}
				});

			$("#add-point").submit(function(){
					geoEncode();
					return false;
				});

			function geoEncode() {
					var address = $("#add-point input[name=address]").val();
					geo.getLocations(address, function (result){
						if (result.Status.code == G_GEO_SUCCESS) {
							geocode = result.Placemark[0].Point.coordinates;
							savePoint(geocode);
						} else {
							var reason="Code "+result.Status.code;
							if (reasons[result.Status.code]) {
								reason = reasons[result.Status.code]
							} 
							$("#add-point .error").html(reason).fadeIn();
							geocode = false;
						}
					});
				}

			function savePoint(geocode) {
					var data = $("#add-point :input").serializeArray();
					data[data.length] = { name: "lng", value: geocode[0] };
					data[data.length] = { name: "lat", value: geocode[1] };
					$.post($("#add-point").attr('action'), data, function(json){
						$("#add-point .error").fadeOut();
						if (json.status == "fail") {
							$("#add-point .error").html(json.message).fadeIn();
						}
						if (json.status == "success") {
							$("#add-point :input[name!=action]").val("");
							var location = json.data;
							addLocation(location);
							zoomToBounds();
						}
					}, "json");
				}

			function addLocation(location) {
					var point = new GLatLng(location.latitute, location.longitude);
					var marker = new GMarker(point);
					map.addOverlay(marker);
					bounds.extend(marker.getPoint());
					
					$("<li />")
						.html(location.locationName)
						.click(function(){
							showMessage(marker, location.locationName);
						})
						.appendTo("#list");
					
					GEvent.addListener(marker, "click", function(){
						showMessage(this, location.locationName);
					});
				}

			function zoomToBounds() {
					map.setCenter(bounds.getCenter());
					map.setZoom(7); // map.getBoundsZoomLevel(bounds)-1
				}

			$("#message").appendTo( map.getPane(G_MAP_FLOAT_SHADOW_PANE) );

			function showMessage(marker, text){
					var markerOffset = map.fromLatLngToDivPixel(marker.getPoint());

					map.panTo(marker.getLatLng());

					$("#message").hide().fadeIn()
						.css({ top:markerOffset.y, left:markerOffset.x })
						.html(text);
				}
			});
		</script>

	<div id="wrapper">

		<div id="map"> </div>
		<ul id="list"> </ul>
		<div id="message" style="display:none;"> </div>

		<form id="add-point" action="map-service.cfc?method=accept" method="post">
			<input type="hidden" name="action" value="savepoint" id="action">

			<fieldset>
				<legend>Add a Point to the Map</legend>
				<div class="error" style="display:none;"> </div>
				<div class="input">
					<label for="name">Location Name</label>
					<input type="text" name="name" id="name" value="" maxlength="85">
				</div>
				<div class="input">
					<label for="address">Address</label>
					<input type="text" name="address" id="address" value="" maxlength="85">
				</div>
				<button type="submit">Add Point</button>
			</fieldset>
		</form>

	</div>
</span>
	</body>
</html>
